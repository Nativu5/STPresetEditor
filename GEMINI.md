---
title: 开发指引
description: 本文档作为开发者指引，指导开发流程和架构设计。
---

# 项目概览

本项目是一个用于编辑和管理 SillyTavern `preset.json` 文件的纯前端在线工具，旨在为复杂 Prompt 工程提供一个现代化、可视化的集成开发环境（IDE）。

## 核心设计

- **技术栈**: Vue 3 (Composition API), Vite, Pinia, Tailwind CSS
- **状态驱动**: 严格遵循 Pinia 作为单一可信源的单向数据流架构。所有操作通过 Actions 提交，驱动 State 变化，UI 通过 Getters 响应式更新。核心数据自动持久化，用户体验无缝。
- **组件化**: 界面被拆分为高内聚、低耦合的 Vue 组件，职责清晰。
- **UI 基础设施**: 结合 Headless UI、Heroicons、Splitpanes 与 VueDraggable，兼顾键盘无障碍、拖拽交互与专业布局。

## 核心功能

- **可视化编辑**: 默认加载示例 `preset.json` 并聚焦目标角色配置。依托 VueDraggable 提供流畅的拖拽排序体验，变更即时写回 `prompt_order` 并持久化。新建或从库中添加 Prompt 时保持上下文插入，支持多选批量操作。
- **角色与校验**:
  - **角色设置**: 在 Prompt 卡片上，用户可通过一个带图标的下拉菜单，轻松设置其在 LLM 上下文中的角色 (`system`, `user`, `assistant`)。
  - **安全校验**: 为防止意外操作，系统内置的 Prompt (`system_prompt: true`) 将禁止删除；由系统管理的 Prompt (`marker: true`) 将锁定其内容，不允许编辑。
- **智能宏系统**: 自动扫描 `prompt_order` 中的所有宏，提供实时预览、语法高亮、未定义引用提示等 IDE 级能力。
- **变量管理**: 在侧边栏提供统一的变量管理视图，标注变量状态（未引用、未定义等），支持一键定位与安全重命名。
- **文件操作**: 支持 JSON 的导入、导出和一键重置，仅更新目标角色配置以保护其他角色数据。
- **高级检索**: Prompt 库支持快速搜索、模糊匹配与结果高亮，便于定位长列表中的目标项。
- **响应式设计**: 桌面端采用 Splitpanes 构建的三栏布局，移动端自动切换为单视图聚焦模式，并通过无障碍模态与抽屉保持完整功能。

## 代码规范

- **代码风格**: 遵循 Vue 3 官方推荐的 Composition API 风格，使用 `<script setup>` 语法糖。
- **工具链**: 必须使用 ESLint 和 Prettier 进行代码质量和格式化检查，确保代码一致性。

---

# 持久化与自动保存

用户所有编辑内容会自动实时保存到浏览器本地，无需手动操作。本项目使用 pinia-plugin-persistedstate，将部分状态信息持久化到浏览器的 `localStorage`。应用启动时会自动恢复上次编辑状态，保证数据安全和连续性。仅核心业务数据（如 prompts、顺序、原始 JSON、宏显示模式）会被持久化，其他的分析结果和 UI 状态均为动态计算。

---

# 宏系统核心 (`Macro System`)

宏系统是本编辑器的核心。它将 `preset.json` 中的 `{{...}}` 文本转化为结构化的数据和可交互的 UI，极大地降低了复杂 Prompt 的维护成本。

### 分析引擎 (`analyzeAllMacros`)

分析引擎是宏系统的大脑，其实现在 `presetStore.js` 中。它遵循一个核心原则：**分析范围严格限定于 `prompt_order` 序列**。任何被“隐藏”（即不在 `prompt_order` 中）的 Prompt 都会被忽略。

引擎通过一个高效的多阶段流程，完成对所有相关宏的解析、分析和状态模拟：

0.  **预处理 (Reset)**: 清空既有的宏分析缓存与快照，确保后续状态纯净。
1.  **解析 (Parsing)**: 将 `prompt_order` 中所有 Prompt 的宏文本，解析为标准化的 `macroData` 对象，并附加到对应的 Prompt 数据上。
2.  **模拟与分析 (Simulation & Analysis)**: 在一个统一的循环中，遍历所有解析出的宏，同时完成两项任务：
    - **静态分析**: 建立一个包含所有 `setvar`/`getvar` 定义与引用的关系图，并记录其所在 Prompt 的 `enabled` 状态。
    - **运行时模拟**: 计算每个 `getvar` 宏在当前执行顺序下的实时值。此模拟会智能地处理 `enabled` 状态：`getvar` 总能看到它之前的变量定义，但只有来自 `enabled: true` 的 Prompt 中的 `setvar` 才能真正改变模拟中的变量值。
3.  **聚合 (Aggregation)**: 将分析和模拟的结果提交到 Pinia store，同步宏快照与变量索引，驱动整个 UI 更新。

### `macroData` 对象结构

这是系统中宏的标准化表示，其字段如下：

| 字段      | 类型             | 描述                                                         |
| :-------- | :--------------- | :----------------------------------------------------------- |
| `id`      | `string`         | 宏实例的唯一 ID，由 `promptId` 和其在内容中的起始位置构成。  |
| `full`    | `string`         | 完整的宏文本，例如 `{{setvar::x::10}}`。                     |
| `type`    | `string`         | 解析后的宏类型，如 `setvar`, `getvar`, `comment`, `random`。 |
| `varName` | `string \| null` | 宏关联的变量名（如果适用）。                                 |
| `value`   | `string \| null` | `setvar` 宏所设定的值。                                      |
| `params`  | `string[]`       | 其他类型宏的参数列表，例如 `random` 宏的选项。               |

### 渲染模式

编辑器提供两种宏的显示模式，以适应不同的使用场景：

- **原始模式 (Raw Mode)**: 默认视图。所有宏，如 `{{getvar::x}}`，都以其原始代码形式高亮显示。此模式用于编辑和查看宏结构。
- **预览模式 (Preview Mode)**: `getvar` 宏会被直接替换为其在当前执行顺序下的真实值（例如 `1200`），并以特殊样式高亮，方便用户预览最终输出。在此模式下，`setvar` 和注释宏会被隐藏，以提供一个更干净的阅读视图。

### 智能校验与高亮

- **未定义变量预警**: 对所有未定义却被引用的 `getvar` 宏给出醒目的错误标记。
- **语法与类型高亮**: 根据宏类型应用差异化颜色和样式，帮助快速识别 `setvar`、`getvar`、随机宏与内置变量。
- **交互式定位**: 从变量视图或宏提示跳转时，高亮所有关联宏，模拟 IDE 的“查找引用”体验。

### 主要宏类型

- **`{{setvar::变量名::值}}`**: 定义或修改一个变量。
- **`{{getvar::变量名}}`**: 引用一个变量的值。
- **`{{//...}}`**: 注释，在编辑器中显示为灰色，会被 AI 忽略。
- **`{{random::...}}`**, **`{{roll ...}}`**: 随机宏，会以特殊颜色高亮。
- **`{{user}}`**, **`{{char}}`**, etc.: 内置变量，会以特殊颜色高亮。
